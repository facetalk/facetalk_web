var app=angular.module("facetalk",["ionic"]),_$=function(id){return document.getElementById(id)};location.hash="/tab/home",app.config(function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8"}),app.config(function($stateProvider,$urlRouterProvider){$stateProvider.state("index",{url:"/index",templateUrl:"index.html"}),$stateProvider.state("tabs",{url:"/tab",templateUrl:"template/tabs.html",resolve:{userinfo:function($ionicUser,$cookie){var name=$cookie.get("_fh_username");return name?$ionicUser.getInfo(name):void 0}},controller:function($scope,$ionicNavBarDelegate,$ionicXmpp,$ionicTip){$scope.select=function(hash){0!=$ionicXmpp.status?$ionicTip.show("您正在视频通话，请点击左上角结束后再切换菜单").timeout():location.hash=hash},$scope.back=function(){$ionicNavBarDelegate.back()}}}),$stateProvider.state("tabs.home",{url:"/home",views:{"tab-home":{templateUrl:"template/home.html",controller:function($rootScope,$scope,$ionicLoading,$ionicXmpp,$ionicClient,$ionicNotice){if($scope.redict=$rootScope.isLogin?$rootScope.isComplete?"":"#/tab/take":"#/tab/login",$scope.askNotice=function(){$ionicNotice.init()},!$ionicClient.supportVideo){var msg="";if($ionicClient.isIOS)msg="目前脸呼暂不支持IOS系统";else if($ionicClient.isPC){var link=$ionicClient.isMAC?"http://rj.baidu.com/soft/detail/25718.html":"http://rj.baidu.com/soft/detail/14744.html";msg='目前脸呼仅支持Chrome和Firefox浏览器,我们建议您使用最新版的Chrome浏览器,<a class="link" target="_blank" href="'+link+'">点击下载Chrome浏览器</a>'}else msg="目前脸呼仅支持Chrome和Firefox浏览器,我们建议您使用最新版的Chrome浏览器";$ionicLoading.show({template:msg})}$scope.doRefresh=function(){$ionicXmpp.online()}}}}}).state("tabs.login",{url:"/login",views:{"tab-home":{templateUrl:"template/login.html"}}}).state("tabs.regist",{url:"/regist",views:{"tab-home":{templateUrl:"template/regist.html"}}}).state("tabs.take",{url:":router/take",views:{"tab-home":{templateUrl:"template/take.html"}}}).state("tabs.detail",{url:"/detail/:jid",views:{"tab-home":{templateUrl:"template/detail.html"}}}).state("tabs.chat",{url:"/chat/:roomid",views:{"tab-home":{templateUrl:"template/chat.html"}}}),$stateProvider.state("tabs.history",{url:"/history",views:{"tab-history":{template:'<ion-nav-bar class="bar-positive"></ion-nav-bar><ion-nav-view name="history"></ion-nav-view>',controller:function($rootScope,$state,$ionicTip){$rootScope.isLogin?$state.go($rootScope.isComplete?"tabs.history.main":"tabs.history.take"):($ionicTip.show("请先登录 ...").timeout(),$state.go("tabs.history.login"))}}}}).state("tabs.history.login",{url:"/login",views:{history:{templateUrl:"template/login.html"}}}).state("tabs.history.regist",{url:"/regist",views:{history:{templateUrl:"template/regist.html"}}}).state("tabs.history.take",{url:":router/take",views:{history:{templateUrl:"template/take.html"}}}).state("tabs.history.main",{url:"/main",views:{history:{templateUrl:"template/history.html",controller:function($rootScope,$scope,$http){var info=$rootScope.userInfo,base=0,offset=10;$scope.hasMore=!0,$scope.loadMore=function(){$http.get("/api/pay/getChatRecords/"+info.username+"/"+base+"/"+offset).success(function(data){var l=data.length;if(l){for(var i=0;l>i;i++){var d=data[i],name=d.partnerUserName,type=d.callType,date=d.beginTime;data[i].img="/avatar/"+name+".40.png",data[i].type="called"==type?"呼入":"呼出",data[i].date=date}$scope.items=$scope.items?$scope.items.concat(data):data,l==offset?(base+=10,$scope.hasMore=!0,$scope.$broadcast("scroll.infiniteScrollComplete")):$scope.hasMore=!1}else $scope.hasMore=!1}).error(function(){})}}}}}).state("tabs.history.detail",{url:"/detail/:jid",views:{history:{templateUrl:"template/detail.html"}}}).state("tabs.history.chat",{url:"/chat/:roomid",views:{history:{templateUrl:"template/chat.html"}}}),$stateProvider.state("tabs.setting",{url:"/setting",views:{"tab-setting":{template:'<ion-nav-bar class="bar-positive"></ion-nav-bar><ion-nav-view name="setting"></ion-nav-view>',controller:function($rootScope,$state,$ionicTip){$rootScope.isLogin?$state.go($rootScope.isComplete?"tabs.setting.main":"tabs.setting.take"):($ionicTip.show("请先登录 ...").timeout(),$state.go("tabs.setting.login"))}}}}).state("tabs.setting.login",{url:"/login",views:{setting:{templateUrl:"template/login.html"}}}).state("tabs.setting.regist",{url:"/regist",views:{setting:{templateUrl:"template/regist.html"}}}).state("tabs.setting.take",{url:":router/take",views:{setting:{templateUrl:"template/take.html"}}}).state("tabs.setting.main",{url:"/main",views:{setting:{templateUrl:"template/setting.html",controller:function($rootScope,$scope,$http,$state,$cookie,$ionicXmpp){var info=$rootScope.userInfo;info.img="/avatar/"+info.username+".100.png?"+(new Date).getTime(),$scope.info=info,$http.get("/api/pay/getCount/rose/"+info.username).success(function(data){$scope.info.count=data.productAmount}),$scope.logout=function(){$cookie.remove("_fh_username"),$ionicXmpp.connection.disconnect(),$ionicXmpp.connection=null,$rootScope.userInfo=null,$rootScope.isLogin=!1,$rootScope.isComplete=!1,$state.go("tabs.setting.login")}}}}}).state("tabs.setting.buyinfo",{url:"/buyinfo",views:{setting:{templateUrl:"template/buyinfo.html"}}}),$urlRouterProvider.otherwise("/tab/home")}),app.factory("$cookie",function(){return{get:function(name){var result,v=document.cookie,start=v.indexOf(name+"="),end=v.indexOf(";",start);if(-1==end&&(end=v.length),start>-1){result=v.substring(start+name.length+1,end);try{result=JSON.parse(result)}catch(e){}return result}return null},set:function(name,value,seconds,path,domain){var path=path||"/",expires="";if(seconds)if(window.ActiveXObject){var d=new Date;d.setTime(d.getTime()+1e3*seconds),expires="expires="+d.toGMTString()}else expires="max-age="+seconds;document.cookie=name+"="+JSON.stringify(value)+";"+expires+";path="+path+";"+(domain?"domain="+domain:"")},remove:function(name,path,domain){this.set(name,"",-1,path,domain)}}}),app.factory("$ionicNotice",function($ionicTip,$http){return{init:function(){try{Notification&&("granted"==Notification.permission||"denied"!=Notification.permission&&($ionicTip.show("请点击允许使用桌面通知，方便及时收到好友的视频请求").timeout(),Notification.requestPermission(function(status){Notification.permission!==status&&(Notification.permission=status),"granted"==status?$http.get("/log_gif/desktop_notice.gif?agree"):"denied"==status&&$http.get("/log_gif/desktop_notice.gif?reject")})))}catch(e){}},setNotice:function(jid,nick){try{Notification&&"granted"==Notification.permission&&new Notification("脸呼通知",{icon:"/avatar/"+jid+".100.png",body:nick+" 请求和您视频通话"})}catch(e){}document.title=nick+" 请求和您视频通话"}}}),app.factory("$ionicStatus",function(){return{isFree:0,isWaiting:1,isContinue:2,isChatting:3}}),app.factory("$ionicClient",function($rootScope){var userAgent=navigator.userAgent,supportVideo=$rootScope.supportVideo=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,isIOS=$rootScope.isIOS=/(?:iphone|ipad)/i.test(userAgent),isPC=$rootScope.isPC=!/(?:mobile|android|iphone)/i.test(userAgent),isMAC=$rootScope.isPC=/macintosh/i.test(userAgent);return{supportVideo:supportVideo,isIOS:isIOS,isPC:isPC,isMAC:isMAC}}),app.factory("$ionicTip",function($ionicLoading,$timeout){return{show:function(msg,noBg){var bl=!0;return"false"==noBg&&(bl=!1),this.timer&&$timeout.cancel(this.timer),$ionicLoading.show({template:msg,noBackdrop:bl}),this},hide:function(){this.timer&&$timeout.cancel(this.timer),$ionicLoading.hide()},timeout:function(timeout,callback){var timeout=timeout||2e3;this.timer=$timeout(function(){$ionicLoading.hide(),"function"==typeof callback&&callback()},timeout)}}}),app.factory("$validor",function($ionicTip){return{msgs:{emailRequired:"邮箱地址不能为空",email:"请输入正确的邮箱地址",pwdRequired:"请输入密码",pwd:"密码格式错误:6~16位字符,区分大小写",nameRequired:"用户名不能为空",name:"用户名格式错误:4~18位汉字或英文字符"},login:function(form){var msg,email=form.loginEmail,pwd=form.loginPassword,msgs=this.msgs;if(email.$invalid){var errors=email.$error;errors.required?msg=msgs.emailRequired:errors.email&&(msg=msgs.email)}else pwd.$invalid&&(msg=msgs.pwdRequired);$ionicTip.show(msg).timeout()},regist:function(form){var msg,email=form.email,pwd=form.password,name=form.name,msgs=this.msgs;if(email.$invalid){var errors=email.$error;errors.required?msg=msgs.emailRequired:errors.email&&(msg=msgs.email)}else if(name.$invalid){var errors=name.$error;msg=errors.required?msgs.nameRequired:msgs.name}else if(pwd.$invalid){var errors=pwd.$error;msg=errors.required?msgs.pwdRequired:msgs.pwd}$ionicTip.show(msg).timeout()}}}),app.factory("$ionicUser",function($rootScope,$http,$ionicTip,$ionicXmpp,$cookie){return{getInfo:function(name,cb){return $http.get("/api/user/get/"+name).success(function(data){$rootScope.userInfo=data,$rootScope.isLogin=!0,$rootScope.isComplete=data.infoCompleteness,data.infoCompleteness&&$ionicXmpp.bind.call($ionicXmpp,data.username),"function"==typeof cb&&cb()})},login:function(email,pwd,cb){var para="loginEmail="+email+"&loginPassword="+pwd,self=this;$http.post("/login",para).success(function(data){var status=data.status;if("success"==status){var username=data.username||$cookie.get("_fh_username");self.getInfo(username,cb)}else $ionicTip.show(data.desc).timeout()}).error(function(){})},regist:function(name,pwd,email,cb){var para="name="+name+"&password="+pwd+"&email="+email,self=this;$http.post("/api/user/register",para).success(function(data){var status=data.status;return"success"==status?self.login(email,pwd,cb):void $ionicTip.show(data.desc).timeout()}).error(function(){})}}}),app.factory("$ionicXmpp",function($rootScope,$http,$state,$ionicPopup,$ionicNavBarDelegate,$ionicTip,$ionicNotice){return{server:"http://42.62.73.61/http-bind",status:0,xmpp:null,popup:null,connection:null,bind:function(name){var self=this;$http.get("/api/user/loginForXmpp/"+name).success(function(data){var con=new Strophe.Connection(self.server);self.xmpp=data,self.connection=con,con.attach(data.jid,data.sid,data.rid,function(status){self.connecting.call(self,status)})}).error(function(body,status){403==status&&($rootScope.isLogin=!1,$rootScope.isComplete=!1)})},connecting:function(status){if(status==Strophe.Status.ATTACHED){var self=this,con=self.connection;con.send($pres().c("show").t("chat")),con.addHandler(self.online,null,"presence"),con.addHandler(function(message){return self.message.call(self,message),!0},null,"message","chat")}},online:function(){$http.get("/xmpp/get/allonline").success(function(data){if(!/\s*null\s*/.test(data)){for(var arr=data.split(","),items=[],i=0;i<arr.length;i++){var jid=arr[i],username=jid.split("@")[0],url=username+".100.png";items.push({jid:jid,username:username,imgUrl:url})}return $rootScope.online=items,$rootScope.$broadcast("scroll.refreshComplete"),!0}})},message:function(message){var con=this.connection,from=message.getAttribute("from"),f_jid=from.split("@")[0],signal=message.childNodes[0].innerHTML,self=this,msg=$msg({type:"chat",to:from}).c("body");if("video"==signal){var nick=message.getAttribute("nick");if(0!=self.status)return void con.send(msg.t("busy"));con.send($pres().c("show").t("dnd")),self.status=2,self.popup=$ionicPopup.confirm({title:"提示信息",template:'<div class="row request"><div class="col col-33 col-center"><img src="/avatar/'+f_jid+'.png"/></div><div class="col col-67"><strong>'+nick+"</strong> 请求和您进行视频聊天，是否同意</div></div>",okText:"同意",cancelText:"拒绝"}),self.popup.then(function(res){if(document.title="脸呼 - 在线视频聊天交友平台",res){var roomid=f_jid+"_"+self.xmpp.jid.split("@")[0];con.send(msg.t("ok")),self.status=3,$state.go("tabs.chat",{roomid:roomid})}else con.send(msg.t("no")),con.send($pres().c("show").t("chat")),self.status=0}),$ionicNotice.setNotice(f_jid,nick),_$("noticeAd").play()}else if("ok"==signal){var roomid=self.xmpp.jid.split("@")[0]+"_"+f_jid;con.send($pres().c("show").t("dnd")),self.status=3,/history/.test(location.hash)?$state.go("tabs.history.chat",{roomid:roomid}):$state.go("tabs.chat",{roomid:roomid})}else if("no"==signal)$ionicTip.show("对方拒绝了您的请求").timeout(),con.send($pres().c("show").t("chat")),self.status=0;else if("busy"==signal)$ionicTip.show("对方正在通话中，请稍后再试 ...").timeout(),con.send($pres().c("show").t("chat")),self.status=0;else if("timeout"==signal){var nick=message.getAttribute("nick");document.title="脸呼 - 在线视频聊天交友平台",$ionicPopup.alert({title:"提示信息",template:'<div class="row request"><div class="col col-33 col-center"><img src="/avatar/'+f_jid+'.png"/></div><div class="col col-67"><strong>'+nick+"</strong> 给您发起了视频请求，由于等待时间较长，请求已中断</div></div>",okText:"确认"}).then(function(){self.popup&&self.popup.close(),con.send($pres().c("show").t("chat")),self.status=0})}else"PermissionDeniedError"==signal&&$ionicTip.show("对方拒绝开启摄像装备，将无法和对方建立连接，请点击左上角结束 ...").timeout(5e3)}}}),app.factory("$ionicVideo",function($rootScope,$http,$ionicNavBarDelegate,$ionicLoading,$ionicXmpp,$ionicTip,$timeout){var isEnder;return{stream:null,loadVideo:function(){var self=this;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia({video:!0,audio:!1},function(stream){var video=document.getElementById("face");$ionicTip.hide(),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,video.src=window.URL.createObjectURL(stream),self.stream=stream},function(){})},take:function(){var videoStream=this.stream,video=document.getElementById("face"),take=document.getElementById("take"),choose=document.getElementById("choose");videoStream&&(video.pause(),take.className="hidden",choose.className="row")},choose:function(callback){var video=document.getElementById("face"),w=video.offsetWidth,h=video.offsetHeight,name=$rootScope.userInfo.username,self=this,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");canvas.width=200,canvas.height=260,ctx.drawImage(video,-(w-200)/2,0,w,h);var para="username="+name+"&picData="+encodeURIComponent(canvas.toDataURL());$http.post("/api/user/savePic",para).success(function(data){var status=data.status;"success"==status?(self.stream.stop(),$ionicLoading.show({template:"您的头像已上传成功,即将返回上一页"}),$rootScope.isComplete=!0,$ionicXmpp.connection||$ionicXmpp.bind.call($ionicXmpp,name),$timeout(function(){$ionicLoading.hide(),callback&&"function"==typeof callback&&callback()},2e3)):$ionicLoading.show({template:data.desc})}).error(function(){}),$ionicLoading.show({template:'<em class="ion-loading-c"></em>&nbsp;&nbsp;正在保存您的资料'})},reset:function(){var video=document.getElementById("face"),take=document.getElementById("take"),choose=document.getElementById("choose");choose.className="hidden",take.className="",video.play()},initRTC:function(opts){var vid,roomid=opts.roomid,con=$ionicXmpp.connection,m_jid=$rootScope.userInfo.username,webrtc=$ionicXmpp.webrtc;webrtc?webrtc.startLocalVideo():(webrtc=$ionicXmpp.webrtc=new SimpleWebRTC({url:"http://42.62.73.27:8888",localVideoEl:"local",remoteVideosEl:"remote",autoRequestMedia:!0}),webrtc.on("readyToCall",function(){webrtc.joinRoom(roomid)}),webrtc.on("videoAdded",function(){$ionicTip.hide(),0==roomid.indexOf(m_jid)&&$http.get("/api/pay/chatRecord/begin/"+roomid.replace("_","/")).success(function(data){vid=data.id}).error(function(){})}),webrtc.on("videoRemoved",function(){isEnder?(con.send($pres().c("show").t("chat")),$ionicXmpp.status=0):($ionicTip.show("对方结束了聊天,请点击左上角结束 ...").timeout(5e3),isEnder=!0),vid&&($http.get("/api/pay/chatRecord/end/"+vid),$http.get("/api/pay/chatTransaction/"+vid))}),webrtc.on("localMediaError",function(err){var name=err.name,jid=roomid.replace(m_jid,"").replace("_","");con.send($msg({type:"chat",to:jid+"@facetalk"}).c("body").t(name)),"PermissionDeniedError"==name&&$ionicTip.show("由于您没有开启摄像装置，将无法与对方进行聊天 ...").timeout(5e3),con.send($pres().c("show").t("chat")),$ionicXmpp.status=0}))},cancelRTC:function(){var webrtc=$ionicXmpp.webrtc;isEnder=!0,webrtc.stopLocalVideo(),webrtc.leaveRoom(),$ionicNavBarDelegate.back()}}}),app.controller("loginCtrl",function($rootScope,$scope,$ionicUser,$validor,$state){var current=$state.current.name,router=/history/.test(current)?"/history":/setting/.test(current)?"/setting":"";$scope.regist="#/tab"+router+"/regist",$scope.login=function(form,user){form.$valid?$ionicUser.login(user.loginEmail,user.loginPassword,function(){$rootScope.isComplete?""==router?$state.go("tabs.home"):(router=router.replace("/","."),$state.go("tabs"+router+".main")):$state.go("tabs"+router+".take")}):$validor.login(form)},$scope.submit=function(event,form,user){var keyCode=event.keyCode||event.which;13==keyCode&&$scope.login(form,user)}}),app.controller("registCtrl",function($scope,$ionicUser,$state,$validor){var current=$state.current.name,router=/history/.test(current)?"/history":/setting/.test(current)?"/setting":"";$scope.next=function(form,user){form.$valid?$ionicUser.regist(user.name,user.password,user.email,function(){""!=router&&(router=router.replace("/",".")),$state.go("tabs"+router+".take")}):$validor.regist(form)},$scope.submit=function(event,form,user){var keyCode=event.keyCode||event.which;13==keyCode&&$scope.next(form,user)}}),app.controller("takeCtrl",function($scope,$state,$ionicVideo,$ionicNavBarDelegate,$ionicTip){var current=$state.current.name,router=/history/.test(current)?"/history":/setting/.test(current)?"/setting":"";$scope.taking=function(){$ionicVideo.take.call($ionicVideo)},$scope.choose=function(){$ionicVideo.choose.call($ionicVideo,function(){""!=router?(router=router.replace("/","."),$state.go("tabs"+router+".main")):$state.go("tabs.home")})},$scope.reset=$ionicVideo.reset,$scope.back=function(){$ionicVideo.stream&&$ionicVideo.stream.stop(),$ionicNavBarDelegate.back()},$ionicVideo.loadVideo.call($ionicVideo),$ionicTip.show("亲，请将摄像头对准您的面部，确保自拍头像清晰。非本人头像会被系统删除哦。")}),app.controller("detailCtrl",function($rootScope,$scope,$stateParams,$http,$ionicXmpp,$ionicTip){var my_jid=$rootScope.userInfo.username,jid=$scope.username=$stateParams.jid,nick=$rootScope.userInfo.name;return jid==my_jid?void($scope.status="自己"):($http.get("/xmpp/user/status/"+jid+"@facetalk/xml").success(function(data){/chat/.test(data)?($scope.status="空闲",$scope.canChat=!0):/dnd/.test(data)?$scope.status="通话中":/(?:error|unavailable)/.test(data)&&($scope.status="不在线")}),$http.get("/api/user/get/"+jid).success(function(data){$scope.info=data}).error(function(){}),void($scope.chat=function(){var con=$ionicXmpp.connection;$http.get("/api/pay/getCount/rose/"+jid).success(function(data){var amount=data.productAmount,price=$scope.info.price||0;amount>=price?(con.send($msg({type:"chat",to:jid+"@facetalk",nick:nick}).c("body").t("video")),con.send($pres().c("show").t("dnd")),$ionicXmpp.status=1,$ionicTip.show("正在发送视频请求，请稍后 ...","false").timeout(2e4,function(){$ionicTip.show("对方没有响应，连接超时，请稍后重试 ...").timeout(5e3),con.send($msg({type:"chat",to:jid+"@facetalk",nick:nick}).c("body").t("timeout")),con.send($pres().c("show").t("chat")),$ionicXmpp.status=0})):$ionicTip.show("您的玫瑰数量不足，请先购买玫瑰").timeout()})}))}),app.controller("chatCtrl",function($scope,$stateParams,$ionicVideo,$ionicTip,$ionicXmpp){$ionicTip.hide(),$ionicVideo.initRTC($stateParams),$ionicTip.show("正在建立连接,请点击允许访问您的摄像设备 ...").timeout(3e4,function(){$ionicTip.show("建立连接超时,请刷新页面或点击左上角结束 ...")}),$scope.close=function(){$ionicXmpp.connection.send($pres().c("show").t("chat")),$ionicXmpp.status=0,$ionicTip.hide(),$ionicVideo.cancelRTC()}});